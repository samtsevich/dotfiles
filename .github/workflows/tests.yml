name: Dotfiles Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test Dotfiles
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck lua5.4
          pip install tomli
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install shellcheck lua
          pip3 install tomli
      
      - name: Run tests
        run: |
          chmod +x tests/test.sh
          ./tests/test.sh
      
      - name: Test Brewfile (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          echo "Validating Brewfile.common..."
          if [ -f common/Brewfile.common ]; then
            echo "✓ Brewfile.common exists"
          fi
      
      - name: Test Brewfile (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Installing Homebrew (if not present)..."
          which brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          
          echo "Validating Brewfiles..."
          if [ -f common/Brewfile.common ]; then
            brew bundle check --file=common/Brewfile.common --no-upgrade || echo "Some packages missing (expected in CI)"
          fi
          
          if [ -f common/Brewfile.mac ]; then
            brew bundle check --file=common/Brewfile.mac --no-upgrade || echo "Some packages missing (expected in CI)"
          fi

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './common'
          severity: warning
          ignore_paths: '.git'
          ignore_names: 'ohmyzsh.sh ohmybash.sh bashit.sh zinit.sh'
        continue-on-error: true

  integration:
    name: Integration Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        shell: [bash, zsh]
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up test environment
        run: |
          # Create necessary directories
          mkdir -p ~/.config
          mkdir -p ~/bin
          
          echo "Test environment set up"
      
      - name: Install Zsh (Ubuntu)
        if: runner.os == 'Linux' && matrix.shell == 'zsh'
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh
      
      - name: Install Oh My Zsh
        if: matrix.shell == 'zsh'
        run: |
          sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || true
      
      - name: Test shell configuration sourcing
        run: |
          export DOTFILES_DIR="$PWD"
          export HOME="$HOME"
          
          # Test sourcing .profile
          ${{ matrix.shell }} -c "source .profile" || echo "Sourcing with warnings (expected without full setup)"
          
          # Test individual components
          ${{ matrix.shell }} -c "source common/aliases.sh"
          
          echo "✓ Shell configuration files can be sourced"
      
      - name: Test symlink creation (dry-run)
        run: |
          echo "Testing symlink commands from README..."
          
          # Backup existing files
          [ -f ~/.${SHELL}rc ] && cp ~/.${SHELL}rc ~/.${SHELL}rc.backup || true
          
          # Test commands (but don't actually create symlinks in CI)
          echo "ln -s $PWD/.profile ~/.zshrc"
          echo "ln -s $PWD/.gitconfig ~/.gitconfig"
          echo "ln -s $PWD/config/starship.toml ~/.config/starship.toml"
          echo "ln -s $PWD/config/wezterm.lua ~/.wezterm.lua"
          
          echo "✓ Symlink commands are valid"

  markdown:
    name: Markdown Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate Markdown
        uses: avto-dev/markdown-lint@v1
        with:
          config: '.markdownlint.json'
          args: 'README.md CLAUDE.md'
        continue-on-error: true
      
      - name: Check README content
        run: |
          echo "Checking README for required sections..."
          
          grep -q "Installation" README.md && echo "✓ Has Installation section"
          grep -q "Homebrew" README.md && echo "✓ Has Homebrew section"
          grep -q "OMZ Plugins" README.md && echo "✓ Has OMZ Plugins section"
          
          echo "✓ README validation complete"
